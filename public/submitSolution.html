<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submeter Solução</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Submeter Solução</h1>
        <form id="submitSolutionForm">
            <div class="mb-3">
                <label for="challengeSelect" class="form-label">Desafio:</label>
                <select id="challengeSelect" name="challengeId" class="form-select" required>
                    <option value="" disabled selected>Selecione um desafio</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="language" class="form-label">Linguagem:</label>
                <select id="language" name="language" class="form-select" required>
                    <option value="Python">Python</option>
                    <option value="Java">Java</option>
                    <option value="Cpp">C++</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="code" class="form-label">Código:</label>
                <textarea id="code" name="code" class="form-control"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submeter Solução</button>
        </form>
    </div>

    <script>
        // Inicializa o CodeMirror
        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            mode: "python",
            theme: "dracula",
            lineNumbers: true,
            autoCloseBrackets: true,
        });
        editor.setSize("100%", "400px");

        // Atualiza o modo do CodeMirror com base na linguagem selecionada
        document.getElementById("language").addEventListener("change", function() {
            var mode = this.value === "Python" ? "text/x-python" :
                       this.value === "Java" ? "text/x-java" : "text/x-c++src";
            editor.setOption("mode", mode);
        });

        // Função para decodificar o token JWT e extrair informações do usuário
        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }

        // Função para carregar o ID do usuário a partir do token armazenado
        function loadUserId() {
            const token = localStorage.getItem('token'); // ou sessionStorage.getItem('token')
            if (token) {
                const decodedToken = parseJwt(token);
                return decodedToken.id; // supondo que o ID do usuário está no campo 'id'
            } else {
                alert('Usuário não está logado. Redirecionando para a página de login.');
                window.location.href = 'login.html';
            }
        }

        // Carrega a lista de desafios
        async function loadChallenges() {
            try {
                const response = await fetch("http://localhost:3000/api/challenges");
                const challenges = await response.json();
                const challengeSelect = document.getElementById("challengeSelect");
                
                challenges.forEach(challenge => {
                    const option = document.createElement("option");
                    option.value = challenge._id; // ID do desafio
                    option.textContent = `${challenge.title} - ${challenge.description}`;
                    challengeSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar desafios:", error);
            }
        }

        // Inicializa a carga dos desafios ao carregar a página
        loadChallenges();

        // Manipulador de envio do formulário
        document.getElementById("submitSolutionForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            var code = editor.getValue();
            var language = document.getElementById("language").value;
            var userId = loadUserId(); // Obter o ID do usuário logado
            var challengeId = document.getElementById("challengeSelect").value;

            var response = await fetch("http://localhost:3000/api/submissions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    userId: userId,
                    challengeId: challengeId,
                    code: code,
                    language: language,
                }),
            });

            if (response.ok) {
                alert("Solução submetida com sucesso!");
            } else {
                alert("Erro ao submeter a solução.");
            }
        });
    </script>
</body>
</html>
